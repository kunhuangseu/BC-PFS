<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Model Comparison - User Throughput</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'PingFang SC', 'Microsoft YaHei', sans-serif; 
      margin: 20px; 
      background: #f5f5f5;
    }
    h2 { margin: 0 0 10px; font-size: 22px; }
    .wrap { max-width: 1400px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .tip { color: #666; margin: 0 0 12px; font-size: 14px; line-height: 1.8; }
    .chartbox { position: relative; width: 100%; height: 700px; margin-bottom: 30px; }
    canvas { position: absolute; left: 0; top: 0; width: 100% !important; height: 100% !important; }
    .stats-box { 
      background: #f9f9f9; 
      padding: 20px 20px 10px 20px; 
      border-radius: 6px; 
      margin-bottom: 20px;
      border-left: 4px solid #1677ff;
    }
    .stats-title { font-size: 16px; font-weight: bold; margin-bottom: 12px; color: #333; }
    .stats-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
      gap: 15px; 
    }
    .stat-item { 
      background: white; 
      padding: 12px 16px; 
      border-radius: 4px; 
      border: 1px solid #e8e8e8;
    }
    .stat-label { font-size: 14px; color: #666; margin-bottom: 4px; }
    .stat-value { font-size: 16px; font-weight: 600; color: #333; }
    .model-accurate { color: #4A90E2; }
    .model-simplified { color: #E67E22; }
    .model-simulation { color: #DC3912; }
    .file-row { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
    .file-btn { 
      display: inline-block; 
      padding: 8px 16px; 
      background: #1677ff; 
      color: #fff; 
      border-radius: 6px; 
      cursor: pointer; 
      user-select: none; 
      transition: background 0.3s;
    }
    .file-btn:hover { background: #3a8bff; }
    .file-name { color: #666; font-size: 14px; }
    input[type="file"].native-file { 
      position: absolute; 
      width: 1px; 
      height: 1px; 
      padding: 0; 
      margin: -1px; 
      overflow: hidden; 
      clip: rect(0,0,0,0); 
      border: 0; 
    }
    /* manual legend (three short lines) */
    .manual-legend { display:flex; align-items:center; justify-content:center; gap:28px; margin: 8px 0 0 0; }
    .manual-legend .legend-item { display:flex; align-items:center; gap:8px; }
    .manual-legend svg { display:block; }
    /* white panel for chart + legend */
    .chart-panel { background:transparent; border:0; padding: 0; margin-top: 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>User Throughput Analysis</h2>
    <p class="tip" style="margin-bottom:20px;">
      <strong class="model-accurate">Simulation</strong>, 
      <strong class="model-simplified">accurate solutions</strong>, and 
      <strong class="model-simulation">simplified solutions</strong> of user throughput
    </p>

    <div class="stats-box">
      <div class="stats-grid">
        <div id="picker">
          <p style="color:#666;margin:0 0 8px;">Please select a JSON format throughput data file (simulation results)</p>
          <input type="file" id="file" class="native-file" accept="application/json" />
          <div class="file-row">
            <label for="file" class="file-btn">Choose File</label>
            <span id="fileName" class="file-name">No file chosen</span>
          </div>
        </div>
      </div>
    </div>
    <div class="chart-panel">
      <div class="chartbox"><canvas id="chart"></canvas></div>
      <!-- manual legend: three short lines (placed below chart, centered) -->
      <div id="manualLegend" class="manual-legend" style="display:none;">
        <div class="legend-item">
          <svg width="48" height="4" aria-hidden="true"><line x1="0" y1="2" x2="48" y2="2" stroke="#E67E22" stroke-width="3" stroke-dasharray="6 4" /></svg>
          <span>Accurate</span>
        </div>
        <div class="legend-item">
          <svg width="48" height="4" aria-hidden="true"><line x1="0" y1="2" x2="48" y2="2" stroke="#DC3912" stroke-width="3" stroke-dasharray="10 5" /></svg>
          <span>Simplified</span>
        </div>
      </div>
      <!-- second row: simulation legend for each user -->
      <div id="manualLegendSim" class="manual-legend" style="display:none; margin-top:6px;">
        <div class="legend-item">
          <svg width="48" height="4" aria-hidden="true"><line x1="0" y1="2" x2="48" y2="2" stroke="rgba(160, 190, 230, 0.70)" stroke-width="3" /></svg>
          <span>User1</span>
        </div>
        <div class="legend-item">
          <svg width="48" height="4" aria-hidden="true"><line x1="0" y1="2" x2="48" y2="2" stroke="rgba(82, 110, 175, 0.82)" stroke-width="3" /></svg>
          <span>User2</span>
        </div>
        <div class="legend-item">
          <svg width="48" height="4" aria-hidden="true"><line x1="0" y1="2" x2="48" y2="2" stroke="rgba(120, 130, 210, 0.70)" stroke-width="3" /></svg>
          <span>User3</span>
        </div>
        <div class="legend-item">
          <svg width="48" height="4" aria-hidden="true"><line x1="0" y1="2" x2="48" y2="2" stroke="rgba(60, 140, 170, 0.75)" stroke-width="3" /></svg>
          <span>User4</span>
        </div>
      </div>
    </div>
  </div>


  <script>
    const scale = 1e8;
    
    // Define colors: simulation (blue solid), accurate (orange dashed), simplified (red dashed)
    const colors = {
      simulation: '#4A90E2',  // Blue (base)
      accurate: '#E67E22',    // Orange
      simplified: '#DC3912'   // Red
    };
    // Distinguish users within Simulation using separated blue shades
    // Map by user index: [User1, User2, User3, User4]
    // Requirement: 2 (darkest) → 4 → 3 → 1 (lightest)
    const simPalette = [
      'rgba(160, 190, 230, 0.70)', // User1: slightly darker
      'rgba(82, 110, 175, 0.82)',  // User2: slightly lighter
      'rgba(120, 130, 210, 0.70)', // User3: soft blue‑violet
      'rgba(60, 140, 170, 0.75)'   // User4: muted blue‑green
    ];

    // Theoretical data for accurate and simplified models
    const theoreticalData = {
      accurate: {
        1: 13.02,
        2: 16.21,
        3: 14.05,
        4: 15.53
      },
      simplified: {
        1: 13.00,
        2: 16.16,
        3: 13.98,
        4: 15.48
      }
    };

    let myChart = null;

    function render(raw){
      const samples = raw.samples || [];
      if (samples.length === 0) { 
        alert('Sample data is empty, please check file content'); 
        return; 
      }

      const usersCount = raw.usersCount || (samples[0]?.throughputs?.length || 0);
      const datasets = [];

      // Create datasets for each user with three lines
      for (let i = 0; i < usersCount; i++) {
        const userNum = i + 1;
        
        // Simulation data (from file)
        const simulationData = samples.map(s => ({ 
          x: Number(s.round), 
          y: Number(s.throughputs[i] || 0) / scale 
        }));
        
        // Create horizontal lines for theoretical models
        const maxRound = samples[samples.length - 1]?.round || 60000;
        const theoreticalPoints = [
          { x: 0, y: 0 },
          { x: maxRound, y: 0 }
        ];
        
        // Accurate model (horizontal line)
        const accuratePoints = theoreticalPoints.map(p => ({
          x: p.x,
          y: theoreticalData.accurate[userNum]
        }));
        
        // Simplified model (horizontal line)
        const simplifiedPoints = theoreticalPoints.map(p => ({
          x: p.x,
          y: theoreticalData.simplified[userNum]
        }));

        // Add datasets for this user
        // Simulation - Blue solid line (per-user different blue shade)
        datasets.push({
          label: `User ${userNum} - Simulation`,
          data: simulationData,
          borderColor: simPalette[(userNum - 1) % simPalette.length],
          backgroundColor: simPalette[(userNum - 1) % simPalette.length],
          borderWidth: 1.5,
          fill: false,
          pointRadius: 0,
          tension: 0.15,
          borderCapStyle: 'round',
          borderJoinStyle: 'round',
        });

        // Accurate - Orange dashed line (thinner, semi-transparent to reduce clutter)
        datasets.push({
          label: `User ${userNum} - Accurate`,
          data: accuratePoints,
          borderColor: 'rgba(230, 126, 34, 0.7)',
          backgroundColor: 'rgba(230, 126, 34, 0.7)',
          borderWidth: 2,
          borderDash: [5, 5],
          fill: false,
          pointRadius: 0,
          tension: 0,
          borderCapStyle: 'butt',
          borderJoinStyle: 'round',
        });

        // Simplified - Red dashed line (thinner, semi-transparent)
        datasets.push({
          label: `User ${userNum} - Simplified`,
          data: simplifiedPoints,
          borderColor: 'rgba(220, 57, 18, 0.7)',
          backgroundColor: 'rgba(220, 57, 18, 0.7)',
          borderWidth: 2,
          borderDash: [10, 5],
          fill: false,
          pointRadius: 0,
          tension: 0,
          borderCapStyle: 'butt',
          borderJoinStyle: 'round',
        });
      }

      // Destroy previous chart if exists
      if (myChart) {
        myChart.destroy();
      }

      const ctx = document.getElementById('chart');
      myChart = new Chart(ctx, {
        type: 'line',
        data: { datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: false,
          plugins: { 
            legend: { 
              display: false
            },
            tooltip: {
              itemSort: (a, b) => b.parsed.y - a.parsed.y,
              callbacks: {
                label: function(context) {
                  return `${context.dataset.label}: ${context.parsed.y.toFixed(2)} Kbps`;
                }
              }
            }
          },
          elements: { line: { borderWidth: 2 } },
          parsing: false,
          scales: {
            x: {
              type: 'linear',
              title: { display: true, text: 'Scheduling rounds', font: { size: 16 } },
              min: 0,
              max: 60000,
              ticks: { stepSize: 6000, callback: (v) => `${v}`, font: { size: 14 } },
              grid: { display: true, color: '#e9e9e9' }
            },
            y: { 
              title: { display: true, text: 'User throughput (Kbps)', font: { size: 16 } }, 
              beginAtZero: true, 
              ticks: { font: { size: 14 } },
              grid: { display: true, color: '#e9e9e9' }
            }
          },
          interaction: {
            mode: 'nearest',
            axis: 'x',
            intersect: false
          }
        }
      });
      // show manual legend after chart is ready
      var ml = document.getElementById('manualLegend');
      if (ml) { ml.style.display = 'flex'; }
      var mls = document.getElementById('manualLegendSim');
      if (mls) { mls.style.display = 'flex'; }
    }

    function setupFileInput() {
      const fileInput = document.getElementById('file');
      const fileNameSpan = document.getElementById('fileName');
      fileInput.addEventListener('change', () => {
        const f = fileInput.files && fileInput.files[0];
        if (!f) { fileNameSpan.textContent = 'No file chosen'; return; }
        fileNameSpan.textContent = f.name;
        const reader = new FileReader();
        reader.onload = (ev) => {
          try { 
            const raw = JSON.parse(ev.target.result); 
            render(raw); 
          }
          catch(err){ 
            alert('JSON parsing failed, please check if the file format is correct: ' + err.message); 
          }
        };
        reader.readAsText(f);
      });
    }

    setupFileInput();
  </script>
</body>
</html>

